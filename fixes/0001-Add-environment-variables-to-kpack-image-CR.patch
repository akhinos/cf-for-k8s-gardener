Special handling for VCAP_SERVICES
---
 lib/cloud_controller/kpack/stager.rb                | 10 ++++++++--
 spec/unit/lib/cloud_controller/kpack/stager_spec.rb |  2 +-
 2 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/lib/cloud_controller/kpack/stager.rb b/lib/cloud_controller/kpack/stager.rb
index b8637d16c..95cf2f323 100644
--- a/lib/cloud_controller/kpack/stager.rb
+++ b/lib/cloud_controller/kpack/stager.rb
@@ -78,8 +78,14 @@ module Kpack
           },
           build: {
             env: staging_details.environment_variables.to_a.
-                  delete_if { |key, value| key == 'VCAP_SERVICES' }.
-                  map { |key, value| { name: key, value: value.to_s } }
+               map do |key, value|
+                  if key == 'VCAP_SERVICES'
+                   value = JSON.generate(value) if value.is_a?(Hash)
+                   key = 'CNB_SERVICES'
+                 end
+                 [key, value]
+               end.
+               map { |key, value| { name: key, value: value.to_s } }
           }
         }
       })
diff --git a/spec/unit/lib/cloud_controller/kpack/stager_spec.rb b/spec/unit/lib/cloud_controller/kpack/stager_spec.rb
index 24f926e58..dd5ef5fd6 100644
--- a/spec/unit/lib/cloud_controller/kpack/stager_spec.rb
+++ b/spec/unit/lib/cloud_controller/kpack/stager_spec.rb
@@ -79,7 +79,7 @@ module Kpack
               }
             },
             build: {
-              env: [{ name: 'BP_JAVA_VERSION', value: '8.*' }, { name: 'BPL_HEAD_ROOM', value: '0' }]
+              env: [{ name: 'BP_JAVA_VERSION', value: '8.*' }, { name: 'BPL_HEAD_ROOM', value: '0' }, { name: 'CNB_SERVICES', value: '{"postgres":[]}' }]
             }
           }
         }))
--
2.26.2
