Special handling for VCAP_SERVICES
---
 lib/cloud_controller/kpack/stager.rb                | 12 +++++++++---
 spec/unit/lib/cloud_controller/kpack/stager_spec.rb |  1 +
 2 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/lib/cloud_controller/kpack/stager.rb b/lib/cloud_controller/kpack/stager.rb
index 132b9e52f..5252d2c11 100644
--- a/lib/cloud_controller/kpack/stager.rb
+++ b/lib/cloud_controller/kpack/stager.rb
@@ -85,9 +85,15 @@ module Kpack
     end

     def get_environment_variables(staging_details)
-      staging_details.environment_variables.
-        except('VCAP_SERVICES').
-        map { |key, value| { name: key, value: value.to_s } }
+      staging_details.environment_variables.to_a.
+                map do |key, value|
+                  if key == 'VCAP_SERVICES'
+                    value = JSON.generate(value) if value.is_a?(Hash)
+                    key = 'CNB_SERVICES'
+                  end
+                  [key, value]
+                end.
+                map { |key, value| { name: key, value: value.to_s } }
     end

     def logger
diff --git a/spec/unit/lib/cloud_controller/kpack/stager_spec.rb b/spec/unit/lib/cloud_controller/kpack/stager_spec.rb
index 146fb97f8..5ef1ada90 100644
--- a/spec/unit/lib/cloud_controller/kpack/stager_spec.rb
+++ b/spec/unit/lib/cloud_controller/kpack/stager_spec.rb
@@ -82,6 +82,7 @@ module Kpack
               env: [
                 { name: 'BP_JAVA_VERSION', value: '8.*' },
                 { name: 'BPL_HEAD_ROOM', value: '0' },
+                { name: 'CNB_SERVICES', value: '{"postgres":[]}' },
               ]
             }
           }
--
2.26.2
