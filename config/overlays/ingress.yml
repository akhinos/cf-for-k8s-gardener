#@ load("@ytt:data", "data")
#@ load("@ytt:overlay", "overlay")

#@ dnsnames = []
{{- range $sub_domain := .Values.sub_domains }}
#@ dnsnames.append("{{ $sub_domain }}" + data.values.system_domain)
{{- end }}

#@overlay/match by=overlay.subset({"kind":"Service", "metadata":{"namespace": "istio-system", "name":"istio-ingressgateway"}})
---
metadata:
  #@overlay/merge
  #@overlay/match missing_ok=True
  annotations:
    cert.gardener.cloud/secretname: {{ .Values.istio_ingressgateway_credential_name }}
    dns.gardener.cloud/class: garden
    dns.gardener.cloud/dnsnames: #@ ",".join(dnsnames)
    dns.gardener.cloud/ttl: "600"

#@overlay/match by=overlay.subset({"kind":"Gateway", "metadata":{"name":"istio-ingressgateway"}})
---
spec:
  servers:
    #@overlay/match by=overlay.subset({"tls": {"credentialName": "istio-ingressgateway-certs"}})
    - tls:
        credentialName: {{ .Values.istio_ingressgateway_credential_name }}

#@overlay/match by=overlay.subset({"kind":"Secret", "metadata":{"name":"istio-ingressgateway-certs"}})
#@overlay/remove
